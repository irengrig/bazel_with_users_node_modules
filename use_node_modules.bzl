def _generate_fine_grained_node_modules(rctx):
    package_json_path = rctx.path(rctx.attr.package_json)
    node_modules_root = rctx.path(str(package_json_path) + "/../node_modules")

    build_file_lines = []
    for path_ in node_modules_root.readdir():
        name = path_.basename
        rctx.symlink(path_, rctx.path(name))
        build_file_lines += ["""filegroup(name = "{name}", srcs = glob(["{name}/**"]), visibility = ["//visibility:public"])""".format(name = name)]

    rctx.file("BUILD", "\n".join(build_file_lines))

generate_fine_grained_node_modules = repository_rule(
    implementation = _generate_fine_grained_node_modules,
    attrs = {
        "package_json": attr.label(),
    },
)

def use_node_modules():
    generate_fine_grained_node_modules(
        name = "generated_node_modules",
        package_json = "//:package.json",
    )
